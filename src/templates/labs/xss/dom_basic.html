{% extends 'labs/xss/xss_lab_base.html' %}

{% block title %}Simple DOM XSS - Django Goat{% endblock %}

{% block lab_content %}
<div class="bg-slate-800 rounded-xl p-6 border border-slate-700 mb-8">
    <h2 class="text-xl font-bold text-white mb-4">Color Picker</h2>
    <p class="text-slate-300 mb-6">
        Choose your favorite color from the dropdown or specify a custom color in the URL using the 'color' parameter.
    </p>

    <div class="flex flex-col md:flex-row md:items-center gap-4 mb-6">
        <select id="colorSelect" class="bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white">
            <option value="">Select a color</option>
            <option value="red">Red</option>
            <option value="blue">Blue</option>
            <option value="green">Green</option>
            <option value="purple">Purple</option>
            <option value="orange">Orange</option>
        </select>

        <button id="applyColor" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
            Apply Color
        </button>
    </div>

    <div class="bg-slate-900 rounded-lg p-6 border border-slate-700">
        <h3 class="text-lg font-semibold text-white mb-4">Preview</h3>
        <div id="colorPreview" class="w-full h-32 rounded-lg border border-slate-700 flex items-center justify-center">
            <p id="colorText" class="text-white text-lg font-semibold">Color will appear here</p>
        </div>
    </div>
</div>
{% endblock %}

{% block lab_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const color = urlParams.get('color');

        if (color) {
       
            const colorPreview = document.getElementById('colorPreview');
            const colorText = document.getElementById('colorText');

            try {
                colorPreview.style.backgroundColor = color;
            } catch (e) {
            }

            // VULNERABLE: Direct innerHTML insertion without any sanitization
            colorText.innerHTML = 'Selected color: ' + color;

            // VULNERABLE: More effective XSS vector using innerHTML on the main container
            // This will execute event handlers and other XSS payloads
            colorPreview.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Color: ' + color + '</div>';
            
            // VULNERABLE: Additional XSS vector using document.write approach
            // This is extremely dangerous and will execute JavaScript
            if (color.toLowerCase().includes('script') || color.toLowerCase().includes('onerror') || color.toLowerCase().includes('onload')) {
                // Force execution by creating a temporary element and using outerHTML
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = color;
                
                // Extract script content and execute it directly
                const scripts = tempContainer.getElementsByTagName('script');
                for (let i = 0; i < scripts.length; i++) {
                    if (scripts[i].innerHTML) {
                        eval(scripts[i].innerHTML);
                    }
                }
                
                // Also handle event handlers by re-inserting the HTML
                if (color.includes('onerror') || color.includes('onload') || color.includes('onmouseover')) {
                    const vulnDiv = document.createElement('div');
                    vulnDiv.innerHTML = color;
                    colorPreview.appendChild(vulnDiv);
                }
            }
        }

        // Handle color selection from dropdown
        document.getElementById('applyColor').addEventListener('click', function () {
            const selectedColor = document.getElementById('colorSelect').value;
            if (selectedColor) {
                window.location.href = '?color=' + selectedColor;
            }
        });

    });
</script>
{% endblock %}