{% extends 'labs/xss/xss_lab_base.html' %}

{% block title %}WebSocket XSS - Django Goat{% endblock %}

{% block lab_content %}
<div class="bg-slate-800 rounded-xl p-6 border border-slate-700 mb-8">
    <h2 class="text-xl font-bold text-white mb-4">WebSocket Chat Simulator</h2>
    
    <div class="bg-slate-900 rounded-lg p-4 border border-slate-700 mb-4">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold text-white">Connection Status</h3>
            <span id="connectionStatus" class="px-2 py-1 rounded text-xs bg-green-600 text-white">Simulated</span>
        </div>
        <p class="text-slate-300 text-sm">This simulates a WebSocket chat application with vulnerable message handling.</p>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
            <div class="bg-slate-900 rounded-lg border border-slate-700 h-64 overflow-y-auto p-4 mb-4" id="chatMessages">
                <div class="text-slate-400 text-sm">Chat messages will appear here...</div>
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="messageInput" placeholder="Type your message..." 
                       class="flex-1 bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white">
                <button id="sendMessage" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition-colors">
                    Send
                </button>
            </div>
        </div>
        
        </div>
    </div>
</div>
{% endblock %}

{% block lab_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendMessage');
        const chatMessages = document.getElementById('chatMessages');
        const payloadButtons = document.querySelectorAll('.payload-btn');
        
        let messageCount = 0;
        let xssDetected = false;
    
        // Simulate WebSocket message sending
        function sendMessage(content) {
            messageCount++;
            const timestamp = new Date().toLocaleTimeString();
            
            // Vulnerable: Direct innerHTML insertion without sanitization
            const messageDiv = document.createElement('div');
            messageDiv.className = 'mb-2 p-2 bg-slate-800 rounded border-l-2 border-purple-500';
            messageDiv.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <div class="flex-1">
                        <span class="text-purple-400 text-sm font-semibold">User${messageCount}</span>
                        <span class="text-slate-400 text-xs ml-2">${timestamp}</span>
                    </div>
                </div>
                <div class="text-white">${content}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Clear the first message if it's the placeholder
            const firstMessage = chatMessages.querySelector('.text-slate-400');
            if (firstMessage && firstMessage.textContent.includes('Chat messages will appear here')) {
                firstMessage.remove();
            }
        }
        
        // Send message handler
        sendButton.addEventListener('click', function() {
            const message = messageInput.value.trim();
            if (message) {
                sendMessage(message);
                messageInput.value = '';
            }
        });
        
        // Enter key handler
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
        
        // Payload button handlers
        payloadButtons.forEach(button => {
            button.addEventListener('click', function() {
                const payload = this.dataset.payload;
                messageInput.value = payload;
                sendMessage(payload);
                messageInput.value = '';
            });
        });

        // Add some initial messages to make it feel more realistic
        setTimeout(() => {
            sendMessage('Welcome to the chat room!');
        }, 500);
        
        setTimeout(() => {
            sendMessage('This chat application processes messages in real-time...');
        }, 1500);
    });
</script>
{% endblock %}